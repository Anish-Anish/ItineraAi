# Conversation Handling - Quick Reference Guide

## üéØ What Was Implemented

Complete conversation management system that allows users to:
1. ‚úÖ Start new conversations
2. ‚úÖ Continue conversations across messages  
3. ‚úÖ View conversation history
4. ‚úÖ Resume old conversations
5. ‚úÖ Refresh page without losing history

---

## üîë Key Concepts

### **conversation_id**
- Generated by **backend** on first message
- Stored in **React state** (not localStorage)
- Sent with every subsequent message in same conversation
- Reset to `null` on page refresh or "New Chat" click

### **Messages**
- Stored in **MongoDB** (backend)
- Current session messages in **React state**
- Cleared on page refresh (but remain in database)
- Can be reloaded from history

### **History**
- Always fetched from **backend** on page load
- Displayed in **left sidebar**
- Click any item to resume that conversation

---

## üé¨ User Scenarios

### **Scenario 1: Brand New User**
1. Opens app ‚Üí sees empty chat
2. Types "Plan trip to Paris"
3. Backend creates conversation with ID: `conv_123`
4. User continues: "Add Eiffel Tower"
5. Same conversation_id (`conv_123`) is used

### **Scenario 2: Returning User**
1. Opens app ‚Üí sees empty chat + history sidebar
2. Clicks previous conversation from sidebar
3. All old messages load
4. Can continue that conversation

### **Scenario 3: Starting Fresh**
1. User is in middle of conversation
2. Clicks "New Chat" button (green plus icon)
3. Chat clears, conversation_id resets
4. Next message creates brand new conversation

### **Scenario 4: Page Refresh**
1. User refreshes browser
2. Active chat clears
3. History still visible in sidebar
4. Can resume by clicking history OR start new chat

---

## üñ•Ô∏è UI Guide

### **Left Sidebar - Collapsed View**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    ‚ò∞    ‚îÇ ‚Üê Menu (open sidebar)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ    ‚ûï   ‚îÇ ‚Üê NEW CHAT button (green)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  
‚îÇ    üí¨   ‚îÇ ‚Üê Chat History
‚îÇ    ‚ù§Ô∏è   ‚îÇ ‚Üê Liked Plans
‚îÇ    ‚öñÔ∏è   ‚îÇ ‚Üê Compare Plans
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **Left Sidebar - Expanded View**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Chat History           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Trip to Paris          ‚îÇ ‚Üê Click to resume
‚îÇ  Dubai Weekend          ‚îÇ ‚Üê Click to resume  
‚îÇ  Kerala Backwaters      ‚îÇ ‚Üê Click to resume
‚îÇ  ...                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **Main Chat Area**
- On page load: Empty
- After sending message: Shows conversation
- After clicking history: Shows that conversation
- After clicking "New Chat": Empty again

---

## üîÑ API Flow Summary

### **New Conversation**
```
Frontend                    Backend
   |                           |
   |--{ query: "..." }-------->|
   |                           | Creates conversation
   |<--{ conversation_id }-----|
   | Stores ID                 |
   |                           |
   |--{ query, conv_id }------>|
   |                           | Uses same conversation
   |<--{ conversation_id }-----|
```

### **Resume Conversation**
```
Frontend                    Backend
   |                           |
   |--GET /conversations------>|
   |<--[ list of convs ]-------|
   |                           |
User clicks conversation       |
   |                           |
   |--GET /conv/{id}/msgs----->|
   |<--[ all messages ]--------|
   | Loads messages            |
   | Sets conversation_id      |
   |                           |
   |--{ query, conv_id }------>|
   |                           | Continues conversation
   |<--{ response }------------|
```

---

## üíª For Developers

### **State Management**
```typescript
// Current conversation ID (null = new conversation)
const [currentConversationId, setCurrentConversationId] = useState<string | null>(null);

// Current messages in active chat
const [messages, setMessages] = useState<Message[]>([]);

// Conversation history from backend
const [conversations, setConversations] = useState<Conversation[]>([]);
```

### **Key Functions**

**Start New Chat**
```typescript
handleNewChat() // Resets everything for fresh start
```

**Load Conversation**
```typescript
loadConversation(conversationId) // Resumes old conversation
```

**Send Message**
```typescript
handleSendMessage(text) 
// Includes conversation_id if it exists
// Extracts conversation_id from response
```

### **API Calls**

**Get History**
```typescript
GET http://localhost:8089/api/conversations?limit=20
```

**Load Conversation**
```typescript
GET http://localhost:8089/api/conversations/{id}/messages
```

**Send Message**
```typescript
POST http://localhost:8089/api/chat
Body: { query: string, conversation_id?: string }
```

---

## üêõ Debugging Tips

### **Check Console Logs**
- "Loaded conversation history: X" ‚Üí History fetched
- "Sending to backend: {...}" ‚Üí Check if conversation_id is included
- "Setting conversation_id: X" ‚Üí ID received from backend
- "Loading conversation: X" ‚Üí History item clicked
- "Conversation loaded successfully" ‚Üí Resume worked

### **Common Issues**

**Problem**: Messages not continuing in same conversation
- **Check**: Is conversation_id being sent in request?
- **Check**: Is backend returning conversation_id in response?

**Problem**: History not showing
- **Check**: Is backend endpoint working? `/api/conversations`
- **Check**: Console for fetch errors

**Problem**: Can't resume old conversation
- **Check**: Is messages endpoint working? `/api/conversations/{id}/messages`
- **Check**: Does conversation_id match in database?

**Problem**: Page refresh loses everything
- **This is expected!** Active chat clears, but history remains

---

## ‚úÖ Success Criteria

Your implementation is working correctly if:

- [ ] Fresh page load shows empty chat + conversation history
- [ ] First message gets a conversation_id from backend
- [ ] Second message uses same conversation_id  
- [ ] Clicking history loads that conversation
- [ ] Continuing from history uses correct conversation_id
- [ ] "New Chat" button starts fresh conversation
- [ ] Page refresh clears active chat but keeps history
- [ ] All console logs show proper flow

---

## üìû Support

If something isn't working:

1. Check console logs for errors
2. Verify backend endpoints are running
3. Check that MongoDB is connected
4. Review `CONVERSATION_HANDLING_COMPLETE.md` for details

---

**Quick Start**: Just open the app, type a message, and the system handles everything automatically! Use "New Chat" button to start fresh, or click history to resume old conversations.
